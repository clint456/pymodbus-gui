# Modbus Slave 文件操作功能使用指南

## 功能概述

Modbus Slave 现已支持文件读写功能，包括：
- **功能码 20**：读取文件记录 (Read File Record)
- **功能码 21**：写入文件记录 (Write File Record)
- 支持触发寄存器配置
- 支持动态长度寄存器
- 支持多文件并发管理

## 配置步骤

### 1. 添加 Slave 时启用文件操作

1. 在"添加 Modbus Slave"对话框中
2. 找到"文件操作配置"组
3. 勾选"启用文件操作功能"

### 2. 添加文件记录

点击"添加文件记录"按钮，配置以下参数：

#### 基本信息
- **文件号**：用于识别文件的唯一编号（0-65535）
- **文件路径**：文件在磁盘上的存储路径
- **最大大小**：文件最大允许大小（字节）
- **固定长度**：文件固定长度（字节）
  - 设置为 0 表示未设置，将使用长度寄存器
  - 设置 > 0 时优先使用此固定长度，不读取长度寄存器
- **只读**：设置为只读后无法写入
- **描述**：文件说明

#### 触发配置（可选）
用于在读取文件前触发设备准备数据：
- **启用触发**：是否启用触发机制
- **触发功能码**：
  - 06 - 写单个寄存器：写入触发地址
  - 03 - 读保持寄存器：读取触发地址
- **触发地址**：触发操作的寄存器地址

#### 长度寄存器配置（当固定长度未设置时使用）
用于从寄存器动态获取文件长度：
- **从寄存器读取长度**：启用动态长度读取
- **长度功能码**：
  - 03 - 读保持寄存器
  - 04 - 读输入寄存器
- **长度地址**：存储文件长度的寄存器起始地址
- **寄存器数量**：读取几个寄存器（1-4个，通常32位长度用2个）

**注意**：读取文件时的长度确定优先级：
1. 优先使用"固定长度"（如果设置了 > 0）
2. 其次使用"长度寄存器"（如果启用且固定长度=0）
3. 最后读取整个文件剩余数据

### 3. 管理文件记录

点击"管理文件记录"查看和删除已配置的文件：
- 显示所有已配置的文件列表
- 可以选择删除不需要的文件记录

## 使用方法

### 启动 Slave 后查看文件

1. 启动 Slave 服务器
2. 切换到"文件操作"标签页
3. 查看所有配置的文件信息

### 读取文件

1. 在文件列表中找到目标文件
2. 点击"读取"按钮
3. 系统显示文件内容（十六进制格式，前256字节预览）

### 写入文件

1. 在文件列表中找到目标文件（非只读）
2. 点击"写入"按钮
3. 输入十六进制数据，空格分隔
   - 例如：`01 02 03 04 AA BB CC DD`
4. 数据将写入文件并保存到磁盘

## 配置示例

### 示例1：固定长度文件读写

```
文件号: 1
文件路径: C:\data\config.bin
最大大小: 4096
固定长度: 1024
只读: 否
描述: 设备配置文件（固定1024字节）
```

使用场景：文件长度固定，每次读取1024字节，适合固定格式的配置文件。

### 示例2：带触发机制的固定长度文件

```
文件号: 2
文件路径: C:\data\log.bin
最大大小: 65535
固定长度: 2048
只读: 是

触发配置:
  启用触发: 是
  触发功能码: 06 - 写单个寄存器
  触发地址: 100
```

使用场景：读取前需要触发设备准备日志数据，日志大小固定2048字节。

### 示例3：动态长度文件（从寄存器获取长度）

```
文件号: 3
文件路径: C:\data\report.bin
最大大小: 10000
固定长度: 0  # 未设置，使用长度寄存器
只读: 是

触发配置:
  启用触发: 是
  触发功能码: 06 - 写单个寄存器
  触发地址: 200

长度寄存器配置:
  从寄存器读取长度: 是
  长度功能码: 03 - 读保持寄存器
  长度地址: 201
  寄存器数量: 2
```

使用场景：
1. 向地址200写入触发值
2. 从地址201-202读取文件实际长度（32位）
3. 根据长度读取文件内容

## 注意事项

1. **文件号唯一性**：同一个 Slave 中的文件号不能重复
2. **文件路径**：确保路径可访问且有读写权限
3. **最大大小**：不要设置过大，避免内存溢出
4. **只读文件**：只读文件无法写入，会返回错误
5. **触发机制**：触发后需等待设备准备数据（约100ms）
6. **长度寄存器**：确保长度寄存器返回正确的字节数

## 与 Modbus 客户端交互

### 客户端读取文件（功能码20）

```go
// 读取文件1的全部内容
response, err := client.ReadFileRecord(1, 0, 500)  // 文件号1，偏移0，读500字
```

### 客户端写入文件（功能码21）

```go
// 写入数据到文件1
data := []byte{0x01, 0x02, 0x03, 0x04}
err := client.WriteFileRecord(1, 0, data)  // 文件号1，偏移0，写入数据
```

## 日志记录

所有文件操作都会记录到日志窗口：
- 文件记录加载
- 文件读取操作
- 文件写入操作
- 错误和警告信息

## 技术支持

如有问题，请查看：
1. 日志窗口中的详细错误信息
2. 文件权限和路径是否正确
3. 文件号是否冲突
4. 触发和长度配置是否正确
